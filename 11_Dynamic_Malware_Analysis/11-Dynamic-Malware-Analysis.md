# 11 ‚Äî Dynamic Malware Analysis üî¨

## Learning Objectives üéØ

- Master dynamic malware analysis methodology
- Set up secure virtual machine environment for analysis
- Install and configure essential analysis tools
- Perform comprehensive malware behavior analysis
- Bypass anti-analysis techniques
- Document findings with IOCs and artifacts

---

## Key Concepts üí°

### 1. What is Dynamic Malware Analysis?

**Definition**: Analysis method where malware is **run and examined** in secure environments. Examines malware behavior by analyzing network, file, process, and registry activities.

**Why Dynamic Analysis First?**:
- SOC analysts race against time
- Faster results than static analysis
- Widely preferred by Tier 1 SOC analysts in daily work
- Can be automated with sandboxes

**Reality**: 
- "Run the malware and examine its activities"
- Seems simple but very difficult/dangerous without proper knowledge
- Should NOT be conducted on host system

### 2. Advantages vs. Disadvantages

**Advantages** ‚úÖ:
- Much faster results than static analysis
- Automated analysis possible with sandboxes
- Requires less technical knowledge than static analysis
- Easier for beginners to learn
- Shows real-world behavior

**Disadvantages** ‚ö†Ô∏è:
- Cannot determine full malware capacity (behavior varies by system)
- Cannot usually analyze advanced malware with dynamic analysis alone
- Need to combine with static analysis for complete picture
- Malware may detect analysis environment and not execute

### 3. Importance for SOC Analysts

**Daily Work Reality**: "I am analyzing suspicious files" - one of most important SOC tasks.

**File Sources**:
- Email attachments
- Antivirus detections on user devices
- Network security product alerts
- File transfers

**Why Not Static Analysis Only?**:
- Both methods have advantages/disadvantages
- Methods do NOT substitute each other
- Need to combine both for complete analysis
- Dynamic first for speed, static for depth

**Analysis Goals**:
- Determine if file is harmful
- Understand malware purpose
- Identify C2 communication
- Extract IOCs for detection/blocking

---

## Required Tools and Software üõ†Ô∏è

### 1. Virtualization Software

**Purpose**: Run different OS on host without risk. Malware cannot escape if configured properly.

**‚ö†Ô∏è Security Note**: Virtualization environments are software - vulnerabilities exist. Keep software up-to-date!

**Popular Options**:
- **VMware Workstation** (Windows/Linux) ‚≠ê
- **VMware Fusion** (macOS)
- **Oracle VirtualBox** (Cross-platform)

**Ideal Environment**: Completely separate physical device + separate network (costly, not necessary to begin).

### 2. Utility Software

**Essential Applications**:
- **Microsoft Office** (analyze docx, xlsx files)
- **Adobe Reader** (PDF analysis)
- **Browser** (Chrome, Firefox)
- **WinRAR** (compressed files)
- **Text Editors** (Notepad++, Sublime Text)

**Why Important**: Attackers check if software installed to determine if running on VM. Install to mimic real user system.

### 3. Debuggers

**Purpose**: Software used by programmers to test code/catch errors. See instructions of process and change program flow.

**Use in Malware Analysis**:
- Learn malware working structure
- Disable prevention mechanisms by modifying code
- Example: Disable check "only run if device name is John"

**Popular Debuggers**:
- **OllyDbg**
- **x64dbg** ‚≠ê
- **WinDbg**
- **Radare2**

**Note**: Not covered in detail in beginners training, but install now for future use.

### 4. Network Monitoring Tools

**Purpose**: Detect network activities - connections, addresses, communication methods.

**Essential Information to Report**:
- Network connections established
- Addresses communicated with
- How malware communicates (protocol, encryption)

**Popular Tools**:
- **Wireshark** ‚≠ê (comprehensive packet analysis)
- **Fiddler** (HTTP/HTTPS traffic)
- **Burp Suite** (web proxy)

### 5. Process Monitoring Tools

**Purpose**: Monitor processes created when malware runs.

**Why Not Task Manager?**: Other tools more useful for malware analysis (features, usability).

**Recommended Tools**:
- **Process Hacker** ‚≠ê (hierarchical process view)
- **Process Explorer** (SysInternals)
- **Procmon** (SysInternals) ‚≠ê (process, file, registry, network)

### 6. File Activity Monitoring Tools

**Why Important**: Malware performs file activities for:
- Collecting information (read files)
- Writing malware components
- Moving to startup folder (persistence)

**Recommended Tool**:
- **Sysmon** ‚≠ê (System Monitor)

### 7. Other Essential Tools

- **SysInternals Suite** ‚≠ê (comprehensive toolkit)
- **CFF Explorer** (PE file analysis)
- **PEView** (PE structure viewer)
- **TriDNet** (file type identification)
- **BinText** (extract strings)
- **PEiD** (packer detection)
- **Regshot** ‚≠ê (registry comparison)
- **HashMyFiles** (file hashing)

---

## Virtual Machine Setup üñ•Ô∏è

### Step 1: Install Virtualization Software

**Recommended**: VMware Workstation (training uses this).

**Download**: Official VMware website.

### Step 2: Obtain Windows ISO

**Tool**: MediaCreationTool (Microsoft official).

**Process**:
1. Run MediaCreationTool
2. Select "Create installation media"
3. Choose Language, Version, Architecture
4. **Recommendation**: Windows 10 64-bit
5. **Why 64-bit?**: Can run both 32-bit AND 64-bit applications (32-bit can only run 32-bit)
6. Select "ISO file" option
7. Choose save directory
8. Wait for ISO creation (may take long time)

### Step 3: Create Virtual Machine

**Steps in VMware Workstation**:
1. Click "Create a New Virtual Machine"
2. Select "Typical (recommended)"
3. Choose "Installer disc image file (iso)" ‚Üí select downloaded ISO
4. Name VM: "Windows10 Dynamic Analysis" (descriptive name)
5. **Disk Size**: Minimum 60-70 GB (will install many tools)
6. Click "Customize Hardware"
7. **RAM**: Minimum 4 GB for 64-bit (lower for 32-bit)
8. Finish and run VM
9. Install Windows normally

### Step 4: Install Tools

Install all tools mentioned in previous section following setup wizards.

---

## VM Configuration (Critical!) ‚öôÔ∏è

### 1. Turn Off Anti-Malware Solutions

**Why**: Don't want antivirus deleting malware you're analyzing!

**Disable Windows Defender**:
- Go to Windows Defender settings
- Disable all active settings
- **Critical**: Turn off "Real-time protection"

**Disable via Group Policy**:
1. Open "edit group policy" (or run `gpedit.msc`)
2. Navigate to: `Computer Configuration > Administrative Templates > Windows Components > Microsoft Defender Antivirus`
3. Set "Turn off Microsoft Defender Antivirus" to **Enabled**
4. Navigate to: `Real-time Protection`
5. Disable "Monitor file and program activity on your computer"

### 2. Rename Virtual OS

**Why**: Malware checks hostname. Common sandbox names: "Sandbox", "Malware", "Cuckoo".

**Action**: Choose random name like normal user (e.g., "Amanda-PC", "John-Desktop").

**How**:
1. Settings ‚Üí System ‚Üí About
2. Click "Rename this PC"
3. **Don't forget**: Change username too!

### 3. Turn Off Auto Updates

**Why**: Malware may exploit OS vulnerabilities. Need OS to be vulnerable for realistic analysis.

**How (Group Policy)**:
1. Open `gpedit.msc`
2. Navigate to: `Computer Configuration > Administrative Templates > Windows Components > Windows Update`
3. Set "Configure Automatic Updates" to **Disabled**

### 4. Disable Hidden Extensions

**Why**: Attackers trick victims with extensions like "Photo.jpg.exe" (appears as "Photo.jpg").

**How**:
1. Open File Explorer
2. File ‚Üí Change folder and search options
3. View tab ‚Üí Uncheck "Hide extensions for known file types"

### 5. Show Hidden Files and Folders

**Why**: Malware hides files. Show by default for easier analysis.

**How**:
1. File Explorer ‚Üí File ‚Üí Change folder and search options
2. View tab ‚Üí Select "Show hidden files, folders, and drives"

### 6. Disable ASLR

**What**: Address Space Layout Randomization (anti-exploit security mechanism).

**Why Disable**: Will interfere with future advanced analysis.

**How (Registry)**:
1. Open Registry Editor
2. Navigate to: `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management`
3. Create REG_DWORD key named "MoveImages"
4. Set value to `0`

### 7. Disable Windows Firewall

**Why**: Prevent security mechanisms interfering with malware.

**How**:
1. Control Panel ‚Üí System and Security ‚Üí Windows Defender Firewall
2. Or search: `Control Panel\System and Security\Windows Defender Firewall\Customize Settings`
3. Select "Turn off Windows Defender Firewall" for all networks

### 8. Mimic End-User System

**Goal**: Make VM look like normal end-user OS to avoid anti-analysis detection.

**Tips**:
- Install popular browsers (Chrome, Firefox)
- Leave files in different directories (Documents, Downloads, Desktop)
- Change desktop background (not default)
- Download small applications through browser (populate Downloads folder)
- Create user documents (Word files, PDFs)
- Add browser bookmarks

### 9. Change Network Settings

**Why**: Prevent malware spreading to other devices via network.

**How (VMware Workstation)**:
1. VM menu ‚Üí Settings
2. Select "Network Adapter"
3. Change to "Custom" (private network)

### 10. Take Snapshot ‚≠ê

**What**: Backup of VM state. Return to clean state after analysis.

**When to Take**: After all configuration + tool installation complete.

**How (VMware)**:
1. VM menu ‚Üí Snapshot ‚Üí Snapshot Manager
2. Click "Take Snapshot"
3. **Tip**: Add descriptive comment (e.g., "Clean Windows 10 with all tools, pre-analysis state")

**Why Critical**: After analyzing malware, VM may be unusable. Restore snapshot for clean environment.

---

## What to Analyze During Dynamic Analysis üîç

### 1. Process Activities ‚≠ê‚≠ê‚≠ê

**Why First**: Large number of activities occur. Filter by malware processes to find solid evidence.

**What to Monitor**:
- Process creation (parent-child relationships)
- Child processes created
- DLLs imported
- User running process
- Process injection into other processes
- Living off the Land Binaries (LOLBAS) usage

**Tool**: Process Hacker (hierarchical view shows child processes under parent).

**Example Malicious Behavior**:
- Malware injects into notepad.exe ‚Üí Must analyze ALL notepad.exe activities after injection
- Malware spawns schtasks.exe (Task Scheduler) ‚Üí Persistence attempt
- Office app spawns powershell.exe ‚Üí Code execution

**Important**: Analyze activities of ALL processes belonging to or used by malware.

### 2. Network Activities

**Why Important**: Malware establishes connections to:
- Download second-stage payload
- Communicate with C2 (Command and Control)
- Spread to other network devices
- Steal data (exfiltration)

**What to Report**:
- Network connections detected
- How malware communicates (protocol, encryption)
- C2 addresses
- Data exfiltration methods

**Tools**:
- **Wireshark** (comprehensive - all protocols)
- **Fiddler** (HTTP/HTTPS specific - easier for web traffic)

**Protocol Focus**: HTTP, SMTP (most common malware communication).

### 3. Registry Activities

**What are Registries**: Hierarchical databases for data storage in Windows. Used by attackers for:
- Stealing data
- Ensuring persistence

**Persistence Registry Keys** (autorun at startup):
```
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce
```

**Challenge**: Registries used by normal processes too. Focus on registry changes made by malware processes only.

**Tool**: Regshot
1. Run Regshot before executing malware
2. Click "1st shot" (collect existing registries)
3. Execute malware and allow time for activity
4. Click "2nd shot" (collect new state)
5. Click "Compare" to see differences

### 4. File Activities

**Why Important**: Malware performs file activities for many reasons. Recently: fileless malware to prevent detection.

**Critical Directories to Monitor**:

**Temp Directory** (volatile files):
- Access via: Win+R ‚Üí `%TEMP%`
- Malware often copies itself here

**Startup Directories** (persistence):
- Access via: Win+R ‚Üí `shell:startup`
- Access via: Win+R ‚Üí `shell:common startup`
- Malware copies itself here for autorun

**Tool**: Procmon (filter by file operations).

---

