
## Dynamic Analysis Workflow üìã

### Pre-Execution Preparation

**‚ö†Ô∏è CRITICAL**: Start monitoring tools BEFORE running malware! Otherwise miss activities.

1. **Start Process Hacker** (monitor processes)
2. **Start Procmon** (monitor process/file/registry/network)
3. **Start Regshot** ‚Üí Click "1st shot"
4. **Start Wireshark** or **Fiddler** (network monitoring)

### Execution

1. Run malware on desktop (will appear under explorer.exe in process tree)
2. Allow sufficient time for activities (some malware has delayed execution)

### Post-Execution Analysis

1. **Regshot**: Click "2nd shot" ‚Üí Click "Compare"
2. **Process Tree**: Procmon ‚Üí "Show Process Tree" button
3. **Filter by Malware Processes**: Right-click parent process ‚Üí "Add process and children to Include filter"
4. **Analyze Each Activity Type**:
   - Process activities (parent-child relationships, schtasks.exe, powershell.exe)
   - Network activities (C2 addresses, protocols, exfiltration)
   - Registry activities (persistence keys, data theft)
   - File activities (dropped files, startup folder, temp folder)

### Documentation

Create analysis report with:
- Malware type identified
- Behaviors observed
- Persistence mechanisms
- C2 addresses
- Exfiltration methods
- IOCs (hashes, domains, IPs, file names)

---

## Practical Examples üß™

### Example #1: Information Stealer

**File**: e-Archive Dekont.exe
**MD5**: `7a0093c743fc33a5e111f2fec269f79b`
**SHA256**: `722ef401e5cbb067c5c33faa402774d3c75ef08e0c8cc4d7e66a9cfa53684088`

**Findings**:

**Process Activities**:
- Created child process: schtasks.exe (Task Scheduler)
- Created scheduled task: "Updates\VbxFiQYCyFDgGL"
- Runs at every logon
- Executes "VbxFiQYCyFDgGL.exe"

**Network Activities**:
- Communicates with domain: `5gw4d[.]xyz`
- URL: `http://5gw4d[.]xyz/PL341/index.php`
- Protocol: HTTP

**Registry Activities**:
- Queries: `HKLM\Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall`
- Purpose: Enumerate installed applications

**File Activities**:
- Copied itself to: `C:\Users\Amanda\AppData\Roaming\VbxFiQYCyFDgGL.exe`
- Reads files from: Firefox, Chrome, Thunderbird (credential theft)

**Conclusion**: Information stealer using Task Scheduler for persistence, communicating with C2 over HTTP.

**Artifacts**:
```
MD5: 7a0093c743fc33a5e111f2fec269f79b
SHA256: 722ef401e5cbb067c5c33faa402774d3c75ef08e0c8cc4d7e66a9cfa53684088
File: e-Archive Dekont.exe
File: VbxFiQYCyFDgGL.exe
Domain: 5gw4d[.]xyz
URL: http://5gw4d[.]xyz/PL341/index.php
```

### Example #2: Snake Keylogger

**File**: Sales Order Sheet.pdf.exe
**MD5**: `411019bcb582ef6e3dab080d99925b4b`
**SHA256**: `f381e338212079c3a03fbbb532cdec44b1d27db03e8cc4c47408ef038885d934`

**Findings**:

**Process Activities**:
- Created child process: regsvcs.exe (PID 7100)
- Legitimate Windows binary (.NET Service Installation Utility)
- **Verified**: Hash check on VirusTotal = Microsoft signed
- **Conclusion**: Process injection or LOLBAS technique

**Network Activities**:
- Checks public IP: `checkip.dyndns.org` (common malware behavior)
- **SMTP Traffic** (suspicious - didn't send email manually!)
- Connects to: `skychine[.]com[.]my:25` (hijacked SMTP server)
- Sends email to: `graceunlimited153@gmail[.]com` (attacker's email)
- Subject: "Pc Name: admin | Snake Keylogger"
- Attachments: "Password.txt", "User.txt" (base64 encoded)

**Email Content** (after base64 decode):
- Username/password from web applications
- Device IP address
- Stolen credentials

**Conclusion**: Snake Keylogger stealing credentials from browsers, exfiltrating via SMTP.

**Artifacts**:
```
MD5: 411019bcb582ef6e3dab080d99925b4b
SHA256: f381e338212079c3a03fbbb532cdec44b1d27db03e8cc4c47408ef038885d934
File: Sales Order Sheet.pdf.exe
Domain: checkip.dyndns.org
Domain: skychine[.]com[.]my
Email: graceunlimited153@gmail[.]com
```

---

## Troubleshooting: Malware Doesn't Execute? ü§î

### 1. Wait Longer

**Why**: Sandboxes tag file as harmless after 3-5 minutes with no activity. Attackers add sleep functions to bypass.

**Action**: Be patient - wait several minutes for activity.

### 2. Execute as Administrator

**Why**: Most malware terminates itself without high privileges.

**Action**: Right-click ‚Üí Run as Administrator.

### 3. Change Language Settings

**Why**: Targeted attacks - malware only runs in specific regions/languages.

**Malware Checks**:
- OS version
- OS language
- Location (via IP geolocation)
- Timezone

**Action**: Configure VM to match target environment.

### 4. Use Different Network (VPN)

**Why**: Geolocation-based targeting. Example: Malware for France only checks if IP is in France.

**Action**: Use VPN to appear from target country.

**How to Guess Target**:
- Email language (Spanish email ‚Üí try Spain, Mexico, Colombia)
- Subject matter (French bank ‚Üí try France)
- File name language

### 5. Other Methods

- Run from different directory (e.g., Desktop vs. Downloads)
- Change screen resolution
- Perform activities while malware runs (move mouse, create processes, type)

---

## Quick Reference üìã

### Dynamic Analysis Checklist

```
Pre-Execution:
‚ñ° Take VM snapshot (clean state)
‚ñ° Start Process Hacker
‚ñ° Start Procmon
‚ñ° Start Regshot ‚Üí 1st shot
‚ñ° Start Wireshark/Fiddler
‚ñ° Verify all tools running

Execution:
‚ñ° Run malware
‚ñ° Allow 5-10 minutes for activity
‚ñ° Monitor for immediate behaviors

Post-Execution:
‚ñ° Regshot ‚Üí 2nd shot ‚Üí Compare
‚ñ° Procmon ‚Üí Show Process Tree
‚ñ° Filter by malware processes
‚ñ° Analyze process activities
‚ñ° Analyze network activities (C2, exfiltration)
‚ñ° Analyze registry activities (persistence)
‚ñ° Analyze file activities (dropped files, locations)
‚ñ° Document all IOCs
‚ñ° Create analysis report
‚ñ° Revert to clean snapshot

Troubleshooting (if no activity):
‚ñ° Wait longer (10-15 minutes)
‚ñ° Run as Administrator
‚ñ° Change language settings
‚ñ° Use VPN (different country)
‚ñ° Try different directory
‚ñ° Change screen resolution
‚ñ° Perform user activities
```

### Key Persistence Mechanisms

| Mechanism | Indicator | Tool to Detect |
|-----------|-----------|----------------|
| **Task Scheduler** | schtasks.exe spawned | Procmon, Process Hacker |
| **Registry Run Keys** | HKCU/HKLM\...\Run | Regshot |
| **Startup Folder** | Files in shell:startup | Procmon (file activities) |
| **Services** | New service created | Services.msc, Registry |
| **WMI Event** | wmic.exe activity | Procmon |

### Common Malware Behaviors

| Behavior | Tool to Detect | Key Indicator |
|----------|----------------|---------------|
| **C2 Communication** | Wireshark, Fiddler | HTTP/HTTPS/DNS to unknown domain |
| **Data Exfiltration** | Wireshark | SMTP, FTP, HTTP POST with data |
| **Credential Theft** | Procmon | Read browser profile folders |
| **Persistence** | Regshot, Procmon | Registry Run keys, Startup folder |
| **Process Injection** | Process Hacker | Legitimate process with network activity |
| **Discovery** | Procmon | Query Uninstall registry, system info |

---

## SOC Focus Points üéØ

1. **Always Use Snapshot**: Revert to clean state after each analysis
2. **Start Tools BEFORE Execution**: Miss activities if started after
3. **Be Patient**: Wait 10-15 minutes (sleep/delayed execution common)
4. **Focus on Processes First**: Filter other activities by malware processes
5. **schtasks.exe = Persistence**: Task Scheduler most common Windows persistence
6. **SMTP Traffic = Exfiltration**: Didn't send email? Malware did
7. **Legitimate Binaries**: regsvcs.exe, powershell.exe can be used maliciously (LOLBAS)
8. **Hash Everything**: Verify if process is legitimate Microsoft binary
9. **Temp + Startup Folders**: Most common malware file locations
10. **Document IOCs Immediately**: Hashes, domains, IPs, file names for blocking

