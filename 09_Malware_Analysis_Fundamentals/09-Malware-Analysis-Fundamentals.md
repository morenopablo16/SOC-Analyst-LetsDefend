# 09 ‚Äî Malware Analysis Fundamentals ü¶†

## Learning Objectives üéØ

- Understand malware definition and its impact on security operations
- Learn different malware types and their characteristics
- Master static and dynamic analysis approaches
- Perform basic malware analysis using sandbox services
- Identify essential skills required for malware analysts

---

## Key Concepts üí°

### 1. Malware Definition

**Definition**: Malware = MALicious softWARE. Software that endangers the security and integrity of systems by targeting a malicious purpose.

**Purpose**: Cyber threat actors use malicious software to achieve various goals:
- Ensuring persistence
- Damaging systems
- Demanding ransom
- Stealing data
- Unauthorized access

**Reality**: 
- No language restriction (malware written in almost all programming languages)
- You don't need to know all languages to start analyzing
- Being familiar with programming makes analysis easier (mandatory for reverse engineering)
- Attackers constantly develop more complex malware
- Methods to make analysis difficult are at advanced level

### 2. Why Malware Analysis Matters for SOC Analysts

**Historical Example: Stuxnet (2010)**
- Created by US and Israeli intelligence services
- Targeted Iran's nuclear program
- Complex structure even by today's standards
- Contained many zero-day vulnerabilities
- Propagated via USB devices
- Damaged Iran's Natanz uranium enrichment plants permanently

**Daily Work Routine**:
- Analysts frequently encounter suspicious files or processes
- Malware used in vast majority of cyber attacks
- Files may arrive via:
  - Email attachments
  - Antivirus detections on user devices
  - Network security product alerts
  - File transfers

**Critical Skills Needed**:
- Analyze whether files are harmful
- Understand purpose of malicious software
- Identify command and control (C2) server communication
- Determine malware type and capabilities

**Career Impact**: Malware analysis is indispensable know-how for Security Analysts. Many techniques available to examine suspicious files using most appropriate methods.

---

## Malware Types üîç

Malicious software divided into types according to functions/purposes/characters. After analysis, you match it with one or more types.

### Common Malware Types

**1. Backdoor**
- Leaves backdoor on infected device
- Allows attacker to access system through backdoor
- Example: Opens network port connected to shell for attacker connection

**2. Adware**
- Often comes bundled with downloaded software
- Causes unwanted advertisements on device
- Some change default search engine
- Not all adware is harmful

**3. Ransomware**
- High-profile type in recent years
- Encrypts and exfiltrates all files on device
- Demands ransom from victims
- Example: WannaCry

**4. Virus**
- One of first malware types seen in the wild
- Term "virus" often used interchangeably with "malware" in daily life
- Self-replicating feature
- Provides persistence by infecting other files on device

**5. Worm**
- Spreads from infected devices to other devices
- Named for spreading behavior
- Example: WannaCry (exploiting MS17-010 vulnerability, caused worldwide panic)

**6. Rootkit**
- Disguises itself by providing high-level authority access
- Hides presence on system
- Difficult to detect and remove

**7. RAT (Remote Access Trojan)**
- Provides full control over device to threat actor
- Allows remote command execution
- Often used for espionage or data theft

**8. Banking Malware**
- Targets banking applications
- Steals money from victims
- Captures credentials and financial data

**9. Keylogger**
- Logs pressed keys
- Sends information to attacker
- Captures passwords, messages, sensitive data

**Important Note**: Malware may contain more than one feature, so it can belong to multiple types simultaneously (e.g., WannaCry = worm + ransomware).

---

## Essential Knowledge for Malware Analysts üìö

Malware analysis seems easy from outside but requires expertise in many aspects. Some Tier 3 SOC Analysts (Subject Matter Experts) focus careers in malware analysis only.

### 1. Operating System Fundamentals and Architecture

**Why Important**: Malware runs on operating systems, so analysts need solid understanding.

**What Malware Exploits**:
- OS features to increase privileges
- Discovery mechanisms
- Persistence techniques

**Windows Examples**:
- Task Scheduler
- Services
- Registry

**Advanced Topics**:
- API (Application Programming Interfaces)
- Syscalls (System Calls)
- Memory Architecture
- Lower-level OS components

### 2. Assembly Language & Programming

**The Compilation Process**:
- Processors only understand 0s and 1s (binary)
- High-level languages (C/C++, Python, Java, Ruby, Go) compiled to binary
- Compilation: Source Code ‚Üí Assembly Language ‚Üí Machine Code (0s and 1s)

**Assembly Language**:
- Lowest-level programming language (excluding binary)
- Each instruction has direct binary counterpart
- Human-readable representation of machine code

**Malware Analysis Context**:
- Compiled malware easily converted to Assembly language
- Converting from Assembly to higher-level language not easy/accurate
- Analysis usually performed through Assembly language
- **Disassembler**: Software that translates machine codes into Assembly

**Importance**: Static code analysis requires Assembly language knowledge.

### 3. Network Protocols and Fundamentals

**Why Important**: Malware exhibits network activity for:
- Hijacking information
- Connecting to command and control (C2) servers
- Downloading second-stage payloads
- Data exfiltration

**Essential Knowledge**: Basic network protocols understanding critical to determine malware purpose.

### 4. Cryptography

**Usage by Legitimate Software**: Provides security in many technologies.

**Usage by Attackers**:
- Complicating analysis
- Preventing detection
- Preventing access to encrypted data

**Examples**:
- Ransomware encrypts files to prevent access without ransom payment
- Obfuscation techniques to hide malicious code
- Encrypted C2 communications

**Frequency**: Cryptography frequently encountered during malware analysis.

---

## Malware Analysis Approaches üî¨

Two different approaches to analyzing malware:

### Static Analysis

**Definition**: Analyzing malicious software by reverse engineering methods **without running** it.

**Process**:
- Decompile/disassemble the malware
- Analyze each step malware will execute
- Determine behavior/capacity without execution

**Advantages**:
- ‚úÖ Device will not be infected (malware not run)
- ‚úÖ Complete control over analysis
- ‚úÖ Can examine all code paths
- ‚úÖ No need for sandbox environment (though VM still recommended)

**Information Examined**:
- P.E. (Portable Executable) Headers
- Imported DLLs
- Exported DLLs
- Strings in binary
- CPU Instructions (Assembly)

**Recommendation**: Perform analysis in virtual OS, not host device.

### Dynamic Analysis

**Definition**: Examining malware behavior on system by **running** it.

**Process**:
- Install applications to examine system events
- Run malicious software
- Monitor behavior in real-time

**Events to Examine**:
- Network Connections
- File Events
- Process Events
- Registry Events

**Advantages**:
- ‚úÖ Fast results
- ‚úÖ Observe real behavior
- ‚úÖ Identify network indicators
- ‚úÖ See actual impact on system

**Disadvantages**:
- ‚ö†Ô∏è Must run in isolated environment
- ‚ö†Ô∏è Some malware stays dormant (evasion techniques)
- ‚ö†Ô∏è May not execute all code paths

---

## Static vs. Dynamic Analysis Comparison ‚öñÔ∏è

### When to Use Each Approach

**Dynamic Analysis** ‚Üí Fast results needed, initial triage
**Static Analysis** ‚Üí Deep understanding required, reverse engineering

**Best Practice**: **Use BOTH approaches together** for complete analysis!

**Reality Check**:
- Cannot say one approach is better than another
- Each has advantages in different conditions
- Using only one approach may not be sufficient
- Both approaches together lead to success

**SOC Analyst Workflow**:
- Level 1-2 SOC analysts: Quick C2 address identification via dynamic analysis
- Level 3 SOC analysts / Malware specialists: Deep dive with static analysis

---

## Dynamic Analysis Example: AnyRun üß™

### AnyRun Overview

**Description**: Interactive sandbox for quick malware analysis.

**Pricing**:
- Free plan available (with limitations)
- Paid plans for advanced features

**‚ö†Ô∏è Free Plan Warning**:
- All analysis visible to others (public)
- Do NOT upload files with personal data
- Usage time restrictions

### Analysis Walkthrough

**Example Malware**: Hash `80b51e872031a2befeb9a0a13e6fc480` (from AbuseCH)

**Steps**:
1. Click "+" (New Task) button
2. Upload file with "Choose a file" button
3. Select parameters:
   - Operating system (Windows/Linux)
   - Architecture (32/64 bit)
4. Click "Run" button
5. Manually execute malware in sandbox
6. Allow time for malware activities (some malware stays dormant)

### AnyRun Interface Panels

**Panel 1**: Interactive OS view
**Panel 2**: Process list (view child processes)
**Panel 3**: Network and file events
**Panel 4**: Process details

### Example Analysis Findings

**Process Events**:
- Malware created 2 child processes:
  - `schtasks.exe` (Task Scheduler for persistence)
  - AgentTesla malware process

**Process ID 2680 Observations**:
- Uses Task Scheduler
- Writes program with old compile time
- Writes many files to user directory

**Process ID 2616 (schtasks.exe)**:
- Command Line: Creates schedule task "Updates\neHneiobyhcrJJ"
- Configuration in file "tmp5383.tmp"
- Executes "neHneiobyhcrJJ.exe"

**Process ID 3140**:
- Recognized as AgentTesla by AnyRun
- Steals credentials
- Creates files in user directory

**Network Connections**:
- Connects to `smtp.godforeu.com`
- Exfiltrates data via SMTP protocol
- Can examine incoming/outgoing data

---

## Malware Analysis Resources üîó

### 29 Sandbox Services for Faster Analysis

**Interactive Sandboxes**:
1. **Anlyz**
2. **Any.run** ‚≠ê
3. **Joe Sandbox**
4. **Hatching Triage**
5. **Cuckoo**
6. **Hybrid Analysis** ‚≠ê
7. **SandDroid** (Android)
8. **SNDBOX**

**Automated Analysis**:
9. **Comodo Valkyrie**
10. **Intezer Analyze**
11. **SecondWrite Malware Deepview**
12. **Jevereg**
13. **IObit Cloud**
14. **BinaryGuard**
15. **BitBlaze**

**File Scanning**:
16. **VirusTotal** ‚≠ê
17. **Jotti**
18. **Virscan**
19. **Virusade**
20. **OPSWAT**

**Threat Intelligence**:
21. **AMAaaS**
22. **IRIS-H**
23. **Gatewatcher Intelligence**
24. **InQuest Labs**
25. **Malware Config**
26. **Malware Hunter Team**

**Specialized Tools**:
27. **Manalyzer**
28. **SandBlast Analysis**
29. **Firmware** (IoT/embedded devices)

---

## Quick Reference üìã

### Malware Analysis Checklist

```
Static Analysis:
‚ñ° Examine PE Headers
‚ñ° Review Imported DLLs
‚ñ° Review Exported DLLs
‚ñ° Extract strings from binary
‚ñ° Analyze CPU instructions (Assembly)
‚ñ° Identify obfuscation techniques
‚ñ° Document findings

Dynamic Analysis:
‚ñ° Set up isolated environment (sandbox/VM)
‚ñ° Run malware
‚ñ° Monitor network connections (C2, exfiltration)
‚ñ° Track file events (created, modified, deleted)
‚ñ° Monitor process events (parent/child relationships)
‚ñ° Track registry events (persistence mechanisms)
‚ñ° Capture network traffic (PCAP)
‚ñ° Allow time for dormant malware activation
‚ñ° Document IOCs (Indicators of Compromise)

Combined Analysis:
‚ñ° Correlate static and dynamic findings
‚ñ° Identify malware type(s)
‚ñ° Determine malware purpose
‚ñ° Extract C2 addresses
‚ñ° List persistence mechanisms
‚ñ° Create analysis report
```

### Key Malware Indicators

| Indicator Type | Examples |
|----------------|----------|
| **Persistence** | Task Scheduler, Registry Run keys, Services, Startup folder |
| **Network** | C2 IP addresses, domains, unusual ports, protocols (SMTP, DNS, HTTP) |
| **Files** | Dropped files, modified system files, encrypted files |
| **Processes** | Suspicious parent-child relationships, process injection, DLL injection |
| **Registry** | New/modified keys, autorun entries, persistence mechanisms |

### Malware Type Quick Reference

| Type | Key Behavior | Priority |
|------|--------------|----------|
| **Ransomware** | File encryption, ransom demand | Critical |
| **Worm** | Self-propagation, network spreading | High |
| **RAT** | Remote control, full access | High |
| **Banking** | Credential theft, financial fraud | High |
| **Backdoor** | Persistent access, open ports | High |
| **Keylogger** | Keystroke logging, data exfiltration | Medium |
| **Rootkit** | Stealth, privilege escalation | High |
| **Virus** | File infection, self-replication | Medium |
| **Adware** | Unwanted ads, browser hijacking | Low |

---

## SOC Focus Points üéØ

1. **Always Use Isolated Environment**: Never analyze malware on production systems or personal devices
2. **Time Allocation**: Dynamic analysis for quick triage (Level 1-2), static analysis for deep investigation (Level 3)
3. **Dormant Malware**: Allow sufficient time for malware to activate (some have time-based triggers)
4. **Process Relationships**: Pay attention to parent-child process trees (schtasks, powershell, cmd spawned by Office apps = suspicious)
5. **Network IOCs Priority**: C2 addresses are critical for blocking and threat hunting
6. **Persistence Mechanisms**: Task Scheduler, Registry, Services are most common Windows persistence methods
7. **Data Exfiltration Protocols**: SMTP, DNS, HTTP/HTTPS commonly used for data theft
8. **Public Sandboxes Warning**: Don't upload sensitive/proprietary files to free public sandboxes
9. **Multiple Analysis**: Use multiple sandboxes/tools for comprehensive results
10. **Documentation**: Always document findings for incident reports and future reference

---

## Practical Tips üí°

### For Beginners
- Start with dynamic analysis using AnyRun or Hybrid Analysis
- Focus on identifying C2 addresses and malware type
- Practice with samples from MalwareBazaar (AbuseCH)
- Join LetsDefend platform for hands-on practice

### For Intermediate Analysts
- Combine static and dynamic analysis
- Learn basic Assembly language
- Understand Windows API calls
- Study MITRE ATT&CK techniques used by malware

### For Advanced Analysts
- Master reverse engineering with IDA Pro/Ghidra
- Learn unpacking and deobfuscation techniques
- Develop YARA rules for detection
- Contribute to malware research community

---

*Note: These notes are based on Let's Defend course material "Malware Analysis Fundamentals". Focus on building foundational knowledge for malware analysis essential for SOC analysts. Advanced techniques (anti-analysis, obfuscation, packing) covered in separate specialized training.*
